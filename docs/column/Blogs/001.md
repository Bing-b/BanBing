## ğŸš© æ¦‚è¦

- token ï¼š
  æœ¬è´¨æ˜¯éªŒè¯èº«ä»½çš„ä»¤ç‰Œï¼Œä¸€èˆ¬ç”±ç”¨æˆ·é€šè¿‡è´¦æˆ·å¯†ç ç™»å½•åï¼ŒæœåŠ¡ç«¯æŠŠè¿™äº›å‡­è¯é€šè¿‡åŠ å¯†ç­‰ä¸€äº›åˆ—æ“ä½œåå¾—åˆ°çš„å­—ç¬¦ä¸²ã€‚
- token ç™»å½•æµç¨‹ï¼š
  - å®¢æˆ·ç«¯ç”¨è´¦æˆ·å¯†ç è¯·æ±‚ç™»å½•ï¼›
  - æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ï¼ŒéªŒè¯è´¦æˆ·å¯†ç ï¼›
  - éªŒè¯æˆåŠŸåï¼ŒæœåŠ¡ç«¯å‘é€ token ç»™å®¢æˆ·ç«¯ï¼›
  - å®¢æˆ·ç«¯æ¥æ”¶åˆ° token åä¿å­˜ï¼Œå¯ä»¥å­˜å‚¨äº sessionstorage æˆ– localstorageï¼›
  - å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚ï¼Œéœ€è¦å°†æºå¸¦ token å‘é€ç»™æœåŠ¡ç«¯ï¼›
  - æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚ï¼ŒéªŒè¯ token,éªŒè¯æˆåŠŸåˆ™å“åº”è¯·æ±‚è¿”å›è¯·æ±‚æ•°æ®ï¼›
- token éªŒè¯ä¼˜ç‚¹ï¼š
  - token å­˜å‚¨äºå®¢æˆ·ç«¯ï¼Œä¸ä¼šå¯¹æœåŠ¡ç«¯é€ æˆå‹åŠ›ï¼Œå³ä¾¿æ˜¯æœåŠ¡ç«¯é›†ç¾¤ï¼Œä¹Ÿä¸ä¼šå¢åŠ ç»´æŠ¤æˆæœ¬ï¼›
  - token åœ¨å‰ç«¯å¯ä»¥ä¸ä¿å­˜äº Cookie ä¸­ï¼Œé¿å… CSRF æ”»å‡»ï¼Œæå‡æ•°æ®çš„å®‰å…¨æ€§ï¼›
  - token ä¸‹å‘åï¼Œåœ¨æœ‰æ•ˆæœŸå†…é•¿ä¹…ç”Ÿæ•ˆï¼ŒæœåŠ¡ç«¯æƒ³å›æ”¶ token æƒé™éå¸¸å›°éš¾ï¼›

## âœŒï¸ æ­¥éª¤ï¼š

### 1.demo æ„å»º

- å‰ç«¯ï¼šé‡‡ç”¨ token + localStorage + vuex åšä»¤ç‰Œå­˜å‚¨éªŒè¯ï¼ŒåŒ…å« axios äºŒæ¬¡å°è£…ã€è·¯ç”±å®ˆå«ã€api æ¨¡å—åŒ–ç­‰æ“ä½œï¼›
- åç«¯ï¼šé‡‡ç”¨ ğŸ‘‰ [mock.js](http://mockjs.com/) è¯·æ±‚æ¨¡æ‹Ÿï¼Œæ¨¡æ‹Ÿç™»å½•æ¥å£æµ‹è¯•æ•°æ®è·å–ç­‰ ï¼›
  é€šè¿‡ vueCLI è„šæ‰‹æ¶æ­å»ºï¼ŒåŒ…å«ä»¥ä¸‹åŸºæœ¬ç»“æ„ï¼š

![é¡¹ç›®ç»“æ„](https://img-blog.csdnimg.cn/9a173b56a79e4b0b89fd031b4818c0ad.png#pic_left)

### 2.åç«¯ Mock

mock æ–‡ä»¶å¤¹ä¸‹æ–°å»º index.jsï¼Œç¼–å†™ç™»å½•ä¸æ•°æ®è·å–æµ‹è¯•æ¥å£ä»¥ä¾¿åé¢æ¨¡æ‹Ÿè¯·æ±‚è°ƒå–ï¼Œæ³¨æ„éœ€è¦åœ¨ main.js å¼•å…¥

```javascript
const Mock = require("mockjs");

// ç™»å½•æ¥å£
Mock.mock("/login", "post", (option) => {
  // è§£æè¯·æ±‚ä½“ body ä¸­æ•°æ®
  let response = JSON.parse(option.body);
  return {
    status: 200,
    message: "è¯·æ±‚æˆåŠŸ",
    data: response,
    token: "authorization-xxxxxx", // æ¨¡æ‹Ÿåç«¯è¿”å› token
  };
});

// æ•°æ®è¯·æ±‚æ¨¡æ‹Ÿ
Mock.mock("/data", "get", (option) => {
  return {
    status: 200,
    message: "è¯·æ±‚æˆåŠŸ",
    data: [1, 2, 3, 4, 5],
  };
});
```

main.js
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/a20ab3ec4f14427687b0413221d8753a.png#pic_left =350x)

### 3ã€login.vue

```html
<template>
  <div>
    <input type="text" v-model="form.username" placeholder="ç”¨æˆ·å">
    <input type="password" v-model="form.password" placeholder="å¯†ç ">
    <button @click="login">ç™»å½•</button>
  </div>
</template>
<script>
import { mapMutations } from 'vuex'
import { Login } from '../api/api.js'
export default {
  name: 'Login',
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      token: ''
    }
  },
  methods: {
    ...mapMutations(['setToken']),

    login() {
      if(this.form.username === '' || this.form.password === '') {
        alert('è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º');
      }else {
        let form = new FormData();
        form.append('username', this.form.username);
        // å¯†ç ä¸€èˆ¬è¦åŠ å¯†å¤„ç†ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚è€Œå®š
        form.append('password', this.form.password);
        Login(form).then(res => {
          console.log(res);
          this.token = 'Bearer' + res.data.token;
          this.setToken({token: this.token});
          this.$router.push('/home');
          alert('ç™»å½•æˆåŠŸ');
        }).catch( err =>{
          alert('è´¦å·å¯†ç é”™è¯¯');
          console.log(err)
        })
      }
    }
  }
}
</script>
</script>
```

### 4ã€home.vue

```html
<template>
  <div class="hello">
    <h1>{{ msg }}</h1>
    <button @click="getData">è·å–æ•°æ®</button>
    <button @click="clearToken">æ¸…é™¤token</button>
  </div>
</template>
<script>
  import { getData } from "@/api/api";
  export default {
    name: "Home",
    data() {
      return {
        msg: "æ•°æ®ç­‰å¾…è·å–",
      };
    },
    methods: {
      getData() {
        getData().then((res) => {
          console.log(res);
          this.msg = res.data.data;
        });
      },
      clearToken() {
        localStorage.removeItem("token");
      },
    },
  };
</script>
```

### 5ã€è·¯ç”± router

æ·»åŠ å‰ç½®è·¯ç”±å®ˆå«ï¼Œè®¿é—®å…¶ä»–é¡µé¢éœ€æºå¸¦ token å¹¶è¿›è¡ŒéªŒè¯

```javascript
import Vue from "vue";
import VueRouter from "vue-router";

const home = () => import("@/components/Home.vue");
const login = () => import("@/components/Login.vue");

Vue.use(VueRouter);

const routes = [
  {
    path: "/",
    redirect: "/login",
  },
  {
    path: "/login",
    name: "login",
    component: login,
  },
  {
    path: "/home",
    name: "home",
    component: home,
  },
];

const router = new VueRouter({
  mode: "history",
  base: process.env.BASE_URL,
  routes,
});

/**
 *	é‡å†™ router.prototype.push é¿å…åŒæ—¶è·³è½¬ç›¸åŒè·¯å¾„æŠ¥é”™
 */
const originalPush = VueRouter.prototype.push;
VueRouter.prototype.push = function push(location, onResolve, onReject) {
  if (onResolve || onReject)
    return originalPush.call(this, location, onResolve, onReject);
  return originalPush.call(this, location).catch((err) => err);
};

// å‰ç½®è·¯ç”±å®ˆå«
router.beforeEach((to, from, next) => {
  if (to.path === "/login") {
    next();
  } else {
    let token = localStorage.getItem("token");
    if (token === null || token === "") {
      next("/login");
    } else {
      next();
    }
  }
});
export default router;
```

### 6ã€vuex å­˜å‚¨

token ç™»å½•è·å–åˆ°åï¼Œä¸€èˆ¬è¦æœ¬åœ° localStorage å’Œ vuex ä¸­å­˜ä¸€ä»½ï¼Œ å­˜ vuex ç›®çš„æ˜¯ç”¨äºéœ€è¦æˆæƒæ¥å£è°ƒç”¨ï¼Œå­˜å…¥ vuex ä¾¿äºç»Ÿä¸€ç®¡ç†ï¼›localStorage æ•°æ®æ˜¯å­˜æ”¾åœ¨ç¡¬ç›˜ä¸­ï¼Œ vuex æ•°æ®æ˜¯å­˜å‚¨å†…å­˜ä¸­è¯»å–é€Ÿåº¦æ›´å¿«ã€‚

```javascript
import Vue from "vue";
import Vuex from "vuex";

Vue.use(Vuex);

export default new Vuex.Store({
  state: {
    // å­˜å‚¨token
    token: localStorage.getItem("token") ? localStorage.getItem("token") : "",
  },
  mutations: {
    // ä¿®æ”¹token ,å¹¶å°†token å­˜å…¥localStorage
    setToken(state, user) {
      state.token = user.token;
      localStorage.setItem("token", user.token);
    },
  },
});
```

### 7ã€axios äºŒæ¬¡å°è£…

ä¸€èˆ¬å¤§å‹é¡¹ç›®éƒ½éœ€è¦å¯¹ axios äºŒæ¬¡å°è£…ï¼Œä»¥ä¾¿è¯·æ±‚ç»Ÿä¸€å¤„ç†ä¸æ¥å£æ¨¡å—åŒ–ç®¡ç†

```javascript
import router from "@/router";
import axios from "axios";
import qs from "qs";

// é…ç½®å¼€å‘&ç”Ÿäº§ç¯å¢ƒæ¥å£ï¼Œæ ¹æ® node ç¯å¢ƒå˜é‡æ¥è¿›è¡Œåˆ¤æ–­
const devBaseURL = "/";
const proBaseURL = "http://prod.xxxx";
const baseURL =
  process.env.NODE_ENV === "development" ? devBaseURL : proBaseURL;

const instance = axios.create({
  baseURL: baseURL,
  timeout: 5000, // è®¾ç½®è¶…æ—¶æ—¶é—´
  withCredentials: true, // è®¾ç½®æ˜¯å¦å…è®¸è·¨åŸŸä¼ é€’çš„ cookie æºå¸¦å‡­è¯
});

// é…ç½®è¯·æ±‚å‚æ•°ä¼ é€’æ ¼å¼ï¼Œé»˜è®¤æ˜¯JSONæ ¼å¼ï¼Œæ ¹æ®æœåŠ¡å™¨å†³å®š
instance.defaults.headers["Content-Type"] = "application/x-www-form-urlencoded";
instance.defaults.transformRequest = (data) => qs.stringify(data);

// é…ç½® axios è¯·æ±‚æ‹¦æˆªå™¨, é…ç½® token ç™»å½•è®¤è¯
instance.interceptors.request.use(
  (config) => {
    // é…ç½®æ¯æ¬¡å‘é€è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å­˜åœ¨ token,å­˜åœ¨åˆ™åœ¨è¯·æ±‚å¤´ header ä¸Šæ·»åŠ  token,
    let token = localStorage.getItem("token");
    token && (config.headers.Authorization = token);
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// é…ç½® axios å“åº”æ‹¦æˆªå™¨
instance.interceptors.response.use(
  // åˆ¤æ–­è¿”å›çŠ¶æ€ç ï¼Œè¿›è¡Œå¯¹åº”çš„æ•°æ®è¿”å›ä¸å¼‚å¸¸æŠ›å‡ºæ“ä½œ
  (response) => {
    if (response.status === 200) {
      return Promise.resolve(response);
    } else {
      return Promise.reject(response);
    }
  },
  // é…ç½®æœåŠ¡å™¨çŠ¶æ€ç ä¸æ˜¯200çš„æƒ…å†µ
  (error) => {
    if (error.response) {
      switch (error.response.status) {
        // 401: æœªç™»å½•
        case 401:
          localStorage.removeItem("token");
          alert("è¿æ¥è¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•");
          router.push({ path: "/" });
          break;
        // 403ï¼š ç™»å½•è¿‡æœŸ
        case 403:
          alert("ç™»å½•è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
          localStorage.removeItem("token");
          router.push({ path: "/" });
          break;
        // 404: è¯·æ±‚ä¸å­˜åœ¨
        case 404:
          alert("ç½‘ç»œè¯·æ±‚ä¸å­˜åœ¨");
          break;
        // 500: æœåŠ¡é”™è¯¯
        case 500:
          alert("ç½‘ç»œè¯·æ±‚æœ‰è¯¯");
        default:
          alert("æœåŠ¡é”™è¯¯");
      }
      //return Promise.reject('æœåŠ¡é”™è¯¯')
    } else {
      // é…ç½®æœåŠ¡å™¨æ²¡æœ‰è¿”å›ç»“æœæƒ…å†µ
      if (!window.navigator.onLine) {
        // æ–­ç½‘æƒ…å†µï¼Œè¿›è¡Œæ–­ç½‘å¤„ç†
        return;
      }
      return Promise.reject(error);
    }
  }
);

export default instance;
```

### 8ã€api.js

å¯¹æ¥å£æ¨¡å—åŒ–å¤„ç†ï¼Œæ–¹ä¾¿ç®¡ç†è°ƒç”¨

```javascript
import request from "../utlls/request";

export function Login(params) {
  return request({
    method: "post",
    url: "/login",
    data: params,
  });
}

export function getData(params) {
  return request({
    method: "get",
    url: "/data",
    params,
  });
}
```

## âœ”ï¸ æµ‹è¯•

- ç¬¬ä¸€ç™»å½•åï¼Œæ‰“å°è¯·æ±‚ç»“æœï¼Œå¯çœ‹åˆ°æ¨¡æ‹Ÿè¯·æ±‚è¿”å›æ•°æ®ä¸­ token å­—æ®µ
  ![tokenè·å–](https://img-blog.csdnimg.cn/677a0ba94d5f4c5e85ee5dfb87d86aea.png#pic_left)
- ç™»å½•åï¼Œç‚¹å‡»â€˜è·å–æ•°æ®â€™æŒ‰é’®ï¼Œæ‰“å°è¯·æ±‚ç»“æœï¼Œå¯çœ‹åˆ°è¯·æ±‚å¤´ Authorization å·²åŒ…å« token
  ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/77df1f0bbd7c4ecb82bfea9e2b196295.png#pic_left)
- ç‚¹å‡»â€˜æ¸…é™¤ tokenâ€™æŒ‰é’®ï¼Œåˆ·æ–°é¡µé¢åˆ™ä¼šè‡ªåŠ¨é€€å›ç™»å½•ç•Œé¢

è‡³æ­¤ç™»å½• demo å®Œæˆï¼Œè‹¥æœ‰é—®é¢˜æ¬¢è¿æŒ‡æ­£ï¼Œç¼–å†™ä¸æ˜“è¿˜æœ›ä¸‰è¿ï¼ğŸ˜˜ğŸ˜˜ğŸ˜˜
